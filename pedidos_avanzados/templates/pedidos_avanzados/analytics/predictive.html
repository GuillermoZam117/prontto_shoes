{% extends "pedidos_avanzados/base.html" %}
{% load static %}

{% block title %}Analytics Predictivo - Pronto Shoes{% endblock %}

{% block extra_head %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
<style>
    .predictive-dashboard {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        min-height: 100vh;
        padding: 2rem 0;
    }
    
    .prediction-card {
        background: rgba(255, 255, 255, 0.95);
        border-radius: 20px;
        padding: 2rem;
        margin-bottom: 2rem;
        backdrop-filter: blur(15px);
        box-shadow: 0 15px 35px rgba(31, 38, 135, 0.2);
        border: 1px solid rgba(255, 255, 255, 0.18);
        transition: all 0.3s ease;
    }
    
    .prediction-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 20px 40px rgba(31, 38, 135, 0.3);
    }
    
    .forecast-metric {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border-radius: 15px;
        padding: 1.5rem;
        margin-bottom: 1rem;
        text-align: center;
        position: relative;
        overflow: hidden;
    }
    
    .forecast-metric::before {
        content: '';
        position: absolute;
        top: 0;
        left: -100%;
        width: 100%;
        height: 100%;
        background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
        transition: left 0.5s;
    }
    
    .forecast-metric:hover::before {
        left: 100%;
    }
    
    .forecast-number {
        font-size: 2.5rem;
        font-weight: 700;
        margin-bottom: 0.5rem;
        text-shadow: 0 2px 4px rgba(0,0,0,0.3);
    }
    
    .forecast-label {
        font-size: 1rem;
        opacity: 0.9;
        font-weight: 500;
    }
    
    .trend-indicator {
        position: absolute;
        top: 1rem;
        right: 1rem;
        font-size: 1.5rem;
    }
    
    .probability-meter {
        background: #f8f9fa;
        border-radius: 10px;
        padding: 1rem;
        margin: 1rem 0;
        position: relative;
        overflow: hidden;
    }
    
    .probability-bar {
        height: 20px;
        border-radius: 10px;
        background: linear-gradient(90deg, #28a745, #ffc107, #dc3545);
        position: relative;
        margin: 0.5rem 0;
    }
    
    .probability-indicator {
        position: absolute;
        top: -5px;
        width: 4px;
        height: 30px;
        background: #333;
        border-radius: 2px;
        transition: left 0.3s ease;
    }
    
    .customer-card {
        background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
        color: white;
        border-radius: 15px;
        padding: 1rem;
        margin-bottom: 1rem;
        transition: all 0.3s ease;
    }
    
    .customer-card:hover {
        transform: scale(1.02);
        box-shadow: 0 10px 20px rgba(240, 147, 251, 0.3);
    }
    
    .scenario-card {
        background: rgba(255, 255, 255, 0.9);
        border: 2px solid transparent;
        border-radius: 15px;
        padding: 1.5rem;
        margin-bottom: 1rem;
        transition: all 0.3s ease;
        cursor: pointer;
    }
    
    .scenario-card.active {
        border-color: #667eea;
        box-shadow: 0 10px 25px rgba(102, 126, 234, 0.2);
    }
    
    .scenario-card:hover {
        border-color: #764ba2;
        transform: translateY(-3px);
    }
    
    .recommendation-badge {
        background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
        color: white;
        padding: 0.5rem 1rem;
        border-radius: 20px;
        font-size: 0.9rem;
        font-weight: 600;
        display: inline-block;
        margin: 0.25rem;
        animation: pulse 2s infinite;
    }
    
    @keyframes pulse {
        0% { box-shadow: 0 0 0 0 rgba(79, 172, 254, 0.7); }
        70% { box-shadow: 0 0 0 10px rgba(79, 172, 254, 0); }
        100% { box-shadow: 0 0 0 0 rgba(79, 172, 254, 0); }
    }
    
    .loading-forecast {
        display: flex;
        justify-content: center;
        align-items: center;
        height: 200px;
        background: rgba(255, 255, 255, 0.1);
        border-radius: 15px;
        backdrop-filter: blur(10px);
    }
    
    .spinner-forecast {
        width: 60px;
        height: 60px;
        border: 4px solid rgba(255, 255, 255, 0.3);
        border-top: 4px solid white;
        border-radius: 50%;
        animation: spin 1s linear infinite;
    }
    
    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }
    
    .confidence-level {
        background: rgba(40, 167, 69, 0.1);
        border: 1px solid #28a745;
        border-radius: 10px;
        padding: 0.75rem;
        margin: 1rem 0;
        text-align: center;
    }
    
    .confidence-high { border-color: #28a745; background: rgba(40, 167, 69, 0.1); }
    .confidence-medium { border-color: #ffc107; background: rgba(255, 193, 7, 0.1); }
    .confidence-low { border-color: #dc3545; background: rgba(220, 53, 69, 0.1); }
    
    @media (max-width: 768px) {
        .predictive-dashboard {
            padding: 1rem 0;
        }
        
        .prediction-card {
            padding: 1rem;
            margin-bottom: 1rem;
        }
        
        .forecast-number {
            font-size: 2rem;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="predictive-dashboard">
    <div class="container-fluid">
        <!-- Header Section -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="prediction-card" x-data="{ autoRefresh: true, refreshInterval: 300000 }">
                    <div class="row align-items-center">
                        <div class="col-md-8">
                            <h2 class="mb-2 text-primary">
                                <i class="fas fa-crystal-ball me-2"></i>
                                Analytics Predictivo
                            </h2>
                            <p class="text-muted mb-0">
                                Proyecciones y predicciones basadas en machine learning e inteligencia artificial
                            </p>
                            <small class="text-secondary">
                                <i class="fas fa-clock me-1"></i>
                                Última actualización: <span id="last-update">{{ last_update|default:"Cargando..." }}</span>
                            </small>
                        </div>
                        <div class="col-md-4 text-end">
                            <div class="btn-group" role="group">
                                <button class="btn btn-outline-primary" onclick="refreshPredictions()">
                                    <i class="fas fa-sync-alt me-1"></i> Actualizar
                                </button>
                                <button class="btn btn-success" onclick="exportPredictions()">
                                    <i class="fas fa-download me-1"></i> Exportar
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Métricas de Proyección Principales -->
        <div class="row mb-4" id="forecast-metrics">
            <div class="col-xl-3 col-md-6">
                <div class="forecast-metric">
                    <div class="trend-indicator" id="revenue-trend">
                        <i class="fas fa-arrow-up text-success"></i>
                    </div>
                    <div class="forecast-number" id="revenue-forecast">
                        ${{ predicciones.proyeccion_ingresos_30_dias|floatformat:2|default:"0.00" }}
                    </div>
                    <div class="forecast-label">Proyección Ingresos 30 días</div>
                </div>
            </div>
            <div class="col-xl-3 col-md-6">
                <div class="forecast-metric">
                    <div class="trend-indicator" id="orders-trend">
                        <i class="fas fa-arrow-up text-success"></i>
                    </div>
                    <div class="forecast-number" id="orders-forecast">
                        {{ predicciones.proyeccion_pedidos|default:"0" }}
                    </div>
                    <div class="forecast-label">Pedidos Proyectados</div>
                </div>
            </div>
            <div class="col-xl-3 col-md-6">
                <div class="forecast-metric">
                    <div class="trend-indicator" id="customers-trend">
                        <i class="fas fa-users text-info"></i>
                    </div>
                    <div class="forecast-number" id="customers-forecast">
                        {{ predicciones.clientes_probables_compra|length|default:"0" }}
                    </div>
                    <div class="forecast-label">Clientes Probables Compra</div>
                </div>
            </div>
            <div class="col-xl-3 col-md-6">
                <div class="forecast-metric">
                    <div class="trend-indicator" id="confidence-trend">
                        <i class="fas fa-check-circle text-success"></i>
                    </div>
                    <div class="forecast-number" id="confidence-level">
                        {{ predicciones.confianza_prediccion|default:"85" }}%
                    </div>
                    <div class="forecast-label">Nivel de Confianza</div>
                </div>
            </div>
        </div>

        <!-- Gráficos de Tendencias Predictivas -->
        <div class="row mb-4">
            <div class="col-lg-8">
                <div class="prediction-card">
                    <h5 class="mb-3">
                        <i class="fas fa-chart-line me-2 text-primary"></i>
                        Tendencias Predictivas - Próximos 3 Meses
                    </h5>
                    <div class="chart-container">
                        <canvas id="predictiveTrendChart" height="300"></canvas>
                    </div>
                    <div class="confidence-level confidence-high mt-3">
                        <strong>Confianza de Predicción:</strong> 
                        <span id="trend-confidence">85%</span>
                        <i class="fas fa-info-circle ms-2" title="Basado en 12 meses de datos históricos"></i>
                    </div>
                </div>
            </div>
            <div class="col-lg-4">
                <div class="prediction-card">
                    <h5 class="mb-3">
                        <i class="fas fa-bullseye me-2 text-primary"></i>
                        Probabilidad de Objetivos
                    </h5>
                    <div class="probability-meter">
                        <label class="small text-muted">Meta Mensual: $50,000</label>
                        <div class="probability-bar">
                            <div class="probability-indicator" style="left: 75%"></div>
                        </div>
                        <div class="d-flex justify-content-between small">
                            <span>0%</span>
                            <span><strong>75%</strong></span>
                            <span>100%</span>
                        </div>
                    </div>
                    
                    <div class="probability-meter">
                        <label class="small text-muted">Meta Trimestral: $140,000</label>
                        <div class="probability-bar">
                            <div class="probability-indicator" style="left: 65%"></div>
                        </div>
                        <div class="d-flex justify-content-between small">
                            <span>0%</span>
                            <span><strong>65%</strong></span>
                            <span>100%</span>
                        </div>
                    </div>

                    <div class="mt-3">
                        <canvas id="goalsProbabilityChart" height="200"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <!-- Clientes con Probabilidad de Compra -->
        <div class="row mb-4">
            <div class="col-lg-6">
                <div class="prediction-card">
                    <h5 class="mb-3">
                        <i class="fas fa-user-check me-2 text-primary"></i>
                        Clientes con Alta Probabilidad de Compra
                    </h5>
                    <div id="probable-customers-container">
                        {% for cliente in predicciones.clientes_probables_compra|slice:":8" %}
                        <div class="customer-card">
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <h6 class="mb-1">{{ cliente.nombre|default:"Cliente" }}</h6>
                                    <small>
                                        <i class="fas fa-calendar me-1"></i>
                                        Última compra: {{ cliente.dias_ultima_compra|default:"0" }} días
                                    </small>
                                </div>
                                <div class="text-end">
                                    <div class="badge bg-light text-dark">
                                        {{ cliente.probabilidad|default:"85" }}%
                                    </div>
                                    <div class="small">probabilidad</div>
                                </div>
                            </div>
                        </div>
                        {% empty %}
                        <div class="text-center py-4">
                            <i class="fas fa-users text-muted" style="font-size: 3rem;"></i>
                            <p class="text-muted mt-2">No hay datos de clientes disponibles</p>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
            <div class="col-lg-6">
                <div class="prediction-card">
                    <h5 class="mb-3">
                        <i class="fas fa-lightbulb me-2 text-primary"></i>
                        Recomendaciones Inteligentes
                    </h5>
                    <div id="smart-recommendations">
                        <div class="recommendation-badge">
                            <i class="fas fa-rocket me-1"></i>
                            Incrementar stock de calzado deportivo
                        </div>
                        <div class="recommendation-badge">
                            <i class="fas fa-envelope me-1"></i>
                            Campaña email para clientes inactivos
                        </div>
                        <div class="recommendation-badge">
                            <i class="fas fa-percentage me-1"></i>
                            Promoción especial fines de semana
                        </div>
                        <div class="recommendation-badge">
                            <i class="fas fa-mobile-alt me-1"></i>
                            Implementar notificaciones push
                        </div>
                        <div class="recommendation-badge">
                            <i class="fas fa-gift me-1"></i>
                            Programa de fidelización avanzado
                        </div>
                        <div class="recommendation-badge">
                            <i class="fas fa-chart-pie me-1"></i>
                            Analizar productos de temporada
                        </div>
                    </div>
                    
                    <div class="mt-4">
                        <h6 class="text-muted">Impacto Estimado de Recomendaciones</h6>
                        <canvas id="recommendationsImpactChart" height="200"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <!-- Escenarios de Predicción -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="prediction-card">
                    <h5 class="mb-4">
                        <i class="fas fa-sitemap me-2 text-primary"></i>
                        Escenarios de Predicción
                    </h5>
                    <div class="row" x-data="{ activeScenario: 'optimistic' }">
                        <div class="col-lg-4">
                            <div class="scenario-card" 
                                 :class="{ 'active': activeScenario === 'optimistic' }"
                                 @click="activeScenario = 'optimistic'">
                                <div class="text-center">
                                    <i class="fas fa-arrow-up text-success" style="font-size: 2rem;"></i>
                                    <h6 class="mt-2 text-success">Escenario Optimista</h6>
                                    <p class="text-muted small">Crecimiento del 25%</p>
                                    <div class="forecast-number text-success">$65,000</div>
                                    <small>Ingresos proyectados</small>
                                </div>
                            </div>
                        </div>
                        <div class="col-lg-4">
                            <div class="scenario-card" 
                                 :class="{ 'active': activeScenario === 'realistic' }"
                                 @click="activeScenario = 'realistic'">
                                <div class="text-center">
                                    <i class="fas fa-minus text-warning" style="font-size: 2rem;"></i>
                                    <h6 class="mt-2 text-warning">Escenario Realista</h6>
                                    <p class="text-muted small">Crecimiento del 10%</p>
                                    <div class="forecast-number text-warning">$52,000</div>
                                    <small>Ingresos proyectados</small>
                                </div>
                            </div>
                        </div>
                        <div class="col-lg-4">
                            <div class="scenario-card" 
                                 :class="{ 'active': activeScenario === 'conservative' }"
                                 @click="activeScenario = 'conservative'">
                                <div class="text-center">
                                    <i class="fas fa-arrow-down text-danger" style="font-size: 2rem;"></i>
                                    <h6 class="mt-2 text-danger">Escenario Conservador</h6>
                                    <p class="text-muted small">Crecimiento del 5%</p>
                                    <div class="forecast-number text-danger">$47,000</div>
                                    <small>Ingresos proyectados</small>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="mt-4">
                        <canvas id="scenariosComparisonChart" height="250"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Loading Overlay -->
<div class="loading-forecast d-none" id="loading-overlay">
    <div class="text-center text-white">
        <div class="spinner-forecast mb-3"></div>
        <h6>Calculando predicciones...</h6>
        <p class="small">Analizando patrones de datos históricos</p>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Configuración inicial
    let charts = {};
    let refreshTimer;
    
    // Cargar datos iniciales
    loadPredictiveData();
    
    // Auto-refresh cada 5 minutos
    refreshTimer = setInterval(loadPredictiveData, 300000);
    
    // Inicializar gráficos
    initializeCharts();
    
    // Función principal para cargar datos predictivos
    function loadPredictiveData() {
        showLoading();
        
        const params = new URLSearchParams({
            tipo: 'predictive',
            format: 'json'
        });
        
        fetch(`/pedidos-avanzados/analytics/api/predictive/?${params}`)
            .then(response => response.json())
            .then(data => {
                updateMetrics(data);
                updateCharts(data);
                updateCustomers(data.clientes_probables_compra || []);
                updateRecommendations(data.recomendaciones || []);
                hideLoading();
                updateLastRefresh();
            })
            .catch(error => {
                console.error('Error loading predictive data:', error);
                hideLoading();
                showError('Error al cargar datos predictivos');
            });
    }
    
    // Inicializar gráficos
    function initializeCharts() {
        // Gráfico de tendencias predictivas
        const trendCtx = document.getElementById('predictiveTrendChart').getContext('2d');
        charts.predictiveTrend = new Chart(trendCtx, {
            type: 'line',
            data: {
                labels: [],
                datasets: [{
                    label: 'Histórico',
                    data: [],
                    borderColor: '#667eea',
                    backgroundColor: 'rgba(102, 126, 234, 0.1)',
                    tension: 0.4
                }, {
                    label: 'Predicción',
                    data: [],
                    borderColor: '#f093fb',
                    backgroundColor: 'rgba(240, 147, 251, 0.1)',
                    borderDash: [5, 5],
                    tension: 0.4
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'top'
                    },
                    title: {
                        display: true,
                        text: 'Predicción de Ingresos - Próximos 90 días'
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        title: {
                            display: true,
                            text: 'Ingresos ($)'
                        }
                    }
                }
            }
        });
        
        // Gráfico de probabilidad de metas
        const goalsCtx = document.getElementById('goalsProbabilityChart').getContext('2d');
        charts.goalsProbability = new Chart(goalsCtx, {
            type: 'doughnut',
            data: {
                labels: ['Probable', 'Incierto'],
                datasets: [{
                    data: [75, 25],
                    backgroundColor: ['#28a745', '#dc3545'],
                    borderWidth: 0
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'bottom'
                    }
                }
            }
        });
        
        // Gráfico de impacto de recomendaciones
        const impactCtx = document.getElementById('recommendationsImpactChart').getContext('2d');
        charts.recommendationsImpact = new Chart(impactCtx, {
            type: 'bar',
            data: {
                labels: ['Stock', 'Email', 'Promociones', 'Push', 'Fidelización'],
                datasets: [{
                    label: 'Impacto Estimado (%)',
                    data: [15, 8, 12, 6, 20],
                    backgroundColor: [
                        'rgba(102, 126, 234, 0.8)',
                        'rgba(240, 147, 251, 0.8)',
                        'rgba(245, 87, 108, 0.8)',
                        'rgba(79, 172, 254, 0.8)',
                        'rgba(0, 242, 254, 0.8)'
                    ],
                    borderRadius: 8
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        display: false
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        title: {
                            display: true,
                            text: 'Impacto (%)'
                        }
                    }
                }
            }
        });
        
        // Gráfico de comparación de escenarios
        const scenariosCtx = document.getElementById('scenariosComparisonChart').getContext('2d');
        charts.scenariosComparison = new Chart(scenariosCtx, {
            type: 'bar',
            data: {
                labels: ['Enero', 'Febrero', 'Marzo'],
                datasets: [{
                    label: 'Optimista',
                    data: [65000, 67000, 70000],
                    backgroundColor: 'rgba(40, 167, 69, 0.8)'
                }, {
                    label: 'Realista',
                    data: [52000, 54000, 56000],
                    backgroundColor: 'rgba(255, 193, 7, 0.8)'
                }, {
                    label: 'Conservador',
                    data: [47000, 48000, 49000],
                    backgroundColor: 'rgba(220, 53, 69, 0.8)'
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'top'
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        title: {
                            display: true,
                            text: 'Ingresos ($)'
                        }
                    }
                }
            }
        });
    }
    
    // Actualizar métricas
    function updateMetrics(data) {
        document.getElementById('revenue-forecast').textContent = 
            `$${parseFloat(data.proyeccion_ingresos_30_dias || 0).toFixed(2)}`;
        document.getElementById('orders-forecast').textContent = 
            data.proyeccion_pedidos || '0';
        document.getElementById('customers-forecast').textContent = 
            (data.clientes_probables_compra || []).length;
        document.getElementById('confidence-level').textContent = 
            `${data.confianza_prediccion || 85}%`;
    }
    
    // Actualizar gráficos
    function updateCharts(data) {
        // Actualizar tendencias predictivas
        if (data.tendencia_historica && charts.predictiveTrend) {
            const historicos = data.tendencia_historica.slice(-30);
            const predicciones = data.predicciones_futuras || [];
            
            charts.predictiveTrend.data.labels = [
                ...historicos.map(d => d.fecha),
                ...predicciones.map(d => d.fecha)
            ];
            
            charts.predictiveTrend.data.datasets[0].data = historicos.map(d => d.ingresos);
            charts.predictiveTrend.data.datasets[1].data = [
                ...new Array(historicos.length).fill(null),
                ...predicciones.map(d => d.ingresos_predichos)
            ];
            
            charts.predictiveTrend.update();
        }
    }
    
    // Actualizar lista de clientes
    function updateCustomers(customers) {
        const container = document.getElementById('probable-customers-container');
        if (customers.length === 0) {
            container.innerHTML = `
                <div class="text-center py-4">
                    <i class="fas fa-users text-muted" style="font-size: 3rem;"></i>
                    <p class="text-muted mt-2">No hay clientes con alta probabilidad de compra</p>
                </div>
            `;
            return;
        }
        
        container.innerHTML = customers.slice(0, 8).map(cliente => `
            <div class="customer-card">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h6 class="mb-1">${cliente.nombre || 'Cliente'}</h6>
                        <small>
                            <i class="fas fa-calendar me-1"></i>
                            Última compra: ${cliente.dias_ultima_compra || 0} días
                        </small>
                    </div>
                    <div class="text-end">
                        <div class="badge bg-light text-dark">
                            ${cliente.probabilidad || 85}%
                        </div>
                        <div class="small">probabilidad</div>
                    </div>
                </div>
            </div>
        `).join('');
    }
    
    // Actualizar recomendaciones
    function updateRecommendations(recommendations) {
        // Las recomendaciones se muestran estáticamente por ahora
        // En una implementación real, vendrían del backend
    }
    
    // Funciones de utilidad
    function showLoading() {
        document.getElementById('loading-overlay').classList.remove('d-none');
    }
    
    function hideLoading() {
        document.getElementById('loading-overlay').classList.add('d-none');
    }
    
    function showError(message) {
        // Implementar notificación de error
        console.error(message);
    }
    
    function updateLastRefresh() {
        document.getElementById('last-update').textContent = new Date().toLocaleString();
    }
    
    // Funciones globales
    window.refreshPredictions = function() {
        loadPredictiveData();
    };
    
    window.exportPredictions = function() {
        const params = new URLSearchParams({
            tipo: 'predictive',
            formato: 'download'
        });
        window.open(`/pedidos-avanzados/analytics/api/predictive/?${params}`, '_blank');
    };
    
    // Cleanup
    window.addEventListener('beforeunload', () => {
        if (refreshTimer) {
            clearInterval(refreshTimer);
        }
    });
});
</script>
{% endblock %}
