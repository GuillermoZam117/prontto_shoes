{% extends "frontend/base.html" %}
{% load static %}

{% block title %}{{ titulo }} - Pedidos Avanzados{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'pedidos_avanzados/css/main.css' %}">
<style>
    /* Estilos específicos para pedidos avanzados */
    .pedidos-avanzados-container {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        min-height: 100vh;
        padding: 20px 0;
    }
    
    .main-card {
        background: white;
        border-radius: 15px;
        box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        margin-bottom: 20px;
        overflow: hidden;
    }
    
    .card-header-custom {
        background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
        color: white;
        padding: 20px;
        border: none;
    }
    
    .card-header-custom h2 {
        margin: 0;
        font-weight: 600;
        display: flex;
        align-items: center;
    }
    
    .card-header-custom i {
        margin-right: 10px;
        font-size: 1.3em;
    }
    
    /* Grilla de órdenes */
    .orden-card {
        border: 1px solid #e9ecef;
        border-radius: 10px;
        transition: all 0.3s ease;
        margin-bottom: 15px;
    }
    
    .orden-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 5px 15px rgba(0,0,0,0.1);
    }
    
    .orden-header {
        background: #f8f9fa;
        padding: 15px;
        border-bottom: 1px solid #e9ecef;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
    
    .orden-numero {
        font-weight: bold;
        color: #495057;
        font-size: 1.1em;
    }
    
    .orden-estado {
        padding: 5px 15px;
        border-radius: 20px;
        font-size: 0.85em;
        font-weight: 600;
        text-transform: uppercase;
    }
    
    .estado-activo { background: #d4edda; color: #155724; }
    .estado-pendiente { background: #fff3cd; color: #856404; }
    .estado-venta { background: #d1ecf1; color: #0c5460; }
    .estado-cancelado { background: #f8d7da; color: #721c24; }
    
    .orden-body {
        padding: 15px;
    }
    
    .orden-info {
        display: grid;
        grid-template-columns: 1fr 1fr 1fr;
        gap: 15px;
        margin-bottom: 15px;
    }
    
    .info-item {
        text-align: center;
    }
    
    .info-label {
        font-size: 0.8em;
        color: #6c757d;
        text-transform: uppercase;
        margin-bottom: 5px;
    }
    
    .info-value {
        font-size: 1.2em;
        font-weight: 600;
        color: #495057;
    }
    
    /* Barra de progreso */
    .progress-container {
        margin: 15px 0;
    }
    
    .progress-bar-custom {
        height: 8px;
        border-radius: 10px;
        background: #e9ecef;
        overflow: hidden;
    }
    
    .progress-fill {
        height: 100%;
        background: linear-gradient(90deg, #4facfe 0%, #00f2fe 100%);
        border-radius: 10px;
        transition: width 0.3s ease;
    }
    
    .progress-text {
        text-align: center;
        margin-top: 5px;
        font-size: 0.9em;
        color: #6c757d;
    }
    
    /* Botones de acción */
    .action-buttons {
        display: flex;
        gap: 10px;
        justify-content: flex-end;
        margin-top: 15px;
    }
    
    .btn-custom {
        padding: 8px 16px;
        border-radius: 20px;
        border: none;
        font-size: 0.85em;
        font-weight: 600;
        text-decoration: none;
        display: inline-flex;
        align-items: center;
        transition: all 0.3s ease;
    }
    
    .btn-custom i {
        margin-right: 5px;
    }
    
    .btn-primary-custom {
        background: linear-gradient(45deg, #667eea, #764ba2);
        color: white;
    }
    
    .btn-primary-custom:hover {
        transform: translateY(-1px);
        box-shadow: 0 3px 10px rgba(102, 126, 234, 0.3);
    }
    
    .btn-success-custom {
        background: linear-gradient(45deg, #56ab2f, #a8e6cf);
        color: white;
    }
    
    .btn-info-custom {
        background: linear-gradient(45deg, #4facfe, #00f2fe);
        color: white;
    }
    
    .btn-warning-custom {
        background: linear-gradient(45deg, #f093fb, #f5576c);
        color: white;
    }
    
    /* Filtros */
    .filters-container {
        background: white;
        border-radius: 10px;
        padding: 20px;
        margin-bottom: 20px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.05);
    }
    
    .filter-row {
        display: grid;
        grid-template-columns: 2fr 1fr 1fr 1fr;
        gap: 15px;
        align-items: end;
    }
    
    /* Responsive */
    @media (max-width: 768px) {
        .orden-info {
            grid-template-columns: 1fr;
            gap: 10px;
        }
        
        .filter-row {
            grid-template-columns: 1fr;
            gap: 10px;
        }
        
        .action-buttons {
            flex-direction: column;
        }
    }
    
    /* Métricas del dashboard */
    .metric-card {
        background: white;
        border-radius: 10px;
        padding: 20px;
        text-align: center;
        box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        transition: transform 0.3s ease;
    }
    
    .metric-card:hover {
        transform: translateY(-2px);
    }
    
    .metric-value {
        font-size: 2.5em;
        font-weight: bold;
        margin-bottom: 10px;
    }
    
    .metric-label {
        color: #6c757d;
        font-size: 0.9em;
        text-transform: uppercase;
    }
    
    .metric-icon {
        font-size: 3em;
        margin-bottom: 15px;
        opacity: 0.7;
    }
    
    /* Tablas */
    .table-custom {
        background: white;
        border-radius: 10px;
        overflow: hidden;
        box-shadow: 0 2px 10px rgba(0,0,0,0.05);
    }
    
    .table-custom thead th {
        background: #f8f9fa;
        border: none;
        color: #495057;
        font-weight: 600;
        text-transform: uppercase;
        font-size: 0.85em;
        padding: 15px;
    }
    
    .table-custom tbody td {
        border: none;
        padding: 15px;
        vertical-align: middle;
    }
    
    .table-custom tbody tr {
        border-bottom: 1px solid #f8f9fa;
    }
    
    .table-custom tbody tr:hover {
        background: #f8f9fa;
    }
</style>
{% endblock %}

{% block content %}
<div class="pedidos-avanzados-container">
    <div class="container-fluid">
        {% block pedidos_content %}
        {% endblock %}
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="{% static 'pedidos_avanzados/js/main.js' %}"></script>
<script>
// Funciones JavaScript comunes para pedidos avanzados

// Actualizar estado de orden vía AJAX
function actualizarEstadoOrden(ordenId, nuevoEstado) {
    $.ajaxSetup({
        beforeSend: function(xhr, settings) {
            if (!csrfSafeMethod(settings.type) && !this.crossDomain) {
                xhr.setRequestHeader("X-CSRFToken", getCookie('csrftoken'));
            }
        }
    });
    
    $.post('{% url "pedidos_avanzados:ajax_actualizar_estado" %}', {
        'orden_id': ordenId,
        'estado': nuevoEstado
    })
    .done(function(data) {
        if (data.success) {
            mostrarMensaje('success', data.message);
            location.reload();
        } else {
            mostrarMensaje('error', data.message);
        }
    })
    .fail(function() {
        mostrarMensaje('error', 'Error al actualizar el estado');
    });
}

// Obtener pedidos de cliente vía AJAX
function obtenerPedidosCliente(clienteId, callback) {
    $.get('{% url "pedidos_avanzados:ajax_pedidos_cliente" %}', {
        'cliente_id': clienteId
    })
    .done(function(data) {
        if (data.success) {
            callback(data.pedidos);
        } else {
            mostrarMensaje('error', data.message);
        }
    })
    .fail(function() {
        mostrarMensaje('error', 'Error al obtener pedidos del cliente');
    });
}

// Mostrar mensajes de notificación
function mostrarMensaje(tipo, mensaje) {
    const alertClass = tipo === 'success' ? 'alert-success' : 'alert-danger';
    const alertHtml = `
        <div class="alert ${alertClass} alert-dismissible fade show" role="alert">
            ${mensaje}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
    `;
    
    // Insertar al inicio del contenido
    $('.pedidos-avanzados-container .container-fluid').prepend(alertHtml);
    
    // Auto-ocultar después de 5 segundos
    setTimeout(function() {
        $('.alert').fadeOut();
    }, 5000);
}

// Funciones de utilidad para CSRF
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

function csrfSafeMethod(method) {
    return (/^(GET|HEAD|OPTIONS|TRACE)$/.test(method));
}

// Formatear números como moneda
function formatearMoneda(valor) {
    return new Intl.NumberFormat('es-MX', {
        style: 'currency',
        currency: 'MXN'
    }).format(valor);
}

// Formatear fechas
function formatearFecha(fecha) {
    return new Date(fecha).toLocaleDateString('es-MX');
}
</script>

{% block pedidos_extra_js %}
{% endblock %}
{% endblock %}
