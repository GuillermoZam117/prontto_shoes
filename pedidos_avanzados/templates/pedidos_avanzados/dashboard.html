{% extends "pedidos_avanzados/base.html" %}
{% load static %}

{% block pedidos_content %}
<!-- Header del Dashboard -->
<div class="main-card">
    <div class="card-header-custom">
        <h2>
            <i class="fas fa-tachometer-alt"></i>
            Dashboard Pedidos Avanzados
        </h2>
    </div>
    
    <!-- Métricas Principales -->
    <div class="card-body p-4">
        <div class="row mb-4">
            <div class="col-lg-3 col-md-6 mb-3">
                <div class="metric-card">
                    <div class="metric-icon text-primary">
                        <i class="fas fa-shopping-cart"></i>
                    </div>
                    <div class="metric-value text-primary">{{ ordenes_activas }}</div>
                    <div class="metric-label">Órdenes Activas</div>
                </div>
            </div>
            
            <div class="col-lg-3 col-md-6 mb-3">
                <div class="metric-card">
                    <div class="metric-icon text-warning">
                        <i class="fas fa-clock"></i>
                    </div>
                    <div class="metric-value text-warning">{{ ordenes_pendientes }}</div>
                    <div class="metric-label">Órdenes Pendientes</div>
                </div>
            </div>
            
            <div class="col-lg-3 col-md-6 mb-3">
                <div class="metric-card">
                    <div class="metric-icon text-info">
                        <i class="fas fa-boxes"></i>
                    </div>
                    <div class="metric-value text-info">{{ total_productos_pendientes }}</div>
                    <div class="metric-label">Productos Pendientes</div>
                </div>
            </div>
            
            <div class="col-lg-3 col-md-6 mb-3">
                <div class="metric-card">
                    <div class="metric-icon text-danger">
                        <i class="fas fa-exclamation-triangle"></i>
                    </div>
                    <div class="metric-value text-danger">{{ notas_por_vencer.count }}</div>
                    <div class="metric-label">Créditos por Vencer</div>
                </div>
            </div>
        </div>
        
        <!-- Accesos Rápidos -->
        <div class="row mb-4">
            <div class="col-12">
                <h4 class="mb-3">
                    <i class="fas fa-bolt text-warning"></i>
                    Accesos Rápidos
                </h4>
            </div>
            
            <div class="col-lg-3 col-md-6 mb-3">
                <a href="{% url 'pedidos_avanzados:grilla_ordenes' %}" class="btn btn-primary-custom w-100 p-3">
                    <i class="fas fa-th-large"></i>
                    <div class="mt-2">Gestión Múltiple</div>
                    <small class="d-block">Administrar todas las órdenes</small>
                </a>
            </div>
            
            <div class="col-lg-3 col-md-6 mb-3">
                <a href="{% url 'pedidos_avanzados:crear_orden' %}" class="btn btn-success-custom w-100 p-3">
                    <i class="fas fa-plus-circle"></i>
                    <div class="mt-2">Nueva Orden</div>
                    <small class="d-block">Crear desde pedidos</small>
                </a>
            </div>
            
            <div class="col-lg-3 col-md-6 mb-3">
                <a href="{% url 'pedidos_avanzados:entregas_parciales' %}" class="btn btn-info-custom w-100 p-3">
                    <i class="fas fa-shipping-fast"></i>
                    <div class="mt-2">Entregas Parciales</div>
                    <small class="d-block">Gestionar entregas</small>
                </a>
            </div>
            
            <div class="col-lg-3 col-md-6 mb-3">
                <a href="{% url 'pedidos_avanzados:reportes' %}" class="btn btn-warning-custom w-100 p-3">
                    <i class="fas fa-chart-bar"></i>
                    <div class="mt-2">Reportes</div>
                    <small class="d-block">Análisis avanzados</small>
                </a>
            </div>
        </div>
    </div>
</div>

<!-- Órdenes Recientes -->
<div class="row">
    <div class="col-lg-8">
        <div class="main-card">
            <div class="card-header-custom">
                <h3 class="mb-0">
                    <i class="fas fa-list"></i>
                    Órdenes Recientes
                </h3>
            </div>
            
            <div class="card-body p-0">
                {% if ordenes_recientes %}
                    <div class="table-responsive">
                        <table class="table table-custom mb-0">
                            <thead>
                                <tr>
                                    <th>Orden</th>
                                    <th>Cliente</th>
                                    <th>Estado</th>
                                    <th>Progreso</th>
                                    <th>Fecha</th>
                                    <th>Acciones</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for orden in ordenes_recientes %}
                                <tr>
                                    <td>
                                        <strong>{{ orden.numero_orden }}</strong>
                                    </td>
                                    <td>
                                        <div>
                                            <strong>{{ orden.cliente.nombre }}</strong>
                                            <br>
                                            <small class="text-muted">{{ orden.cliente.telefono }}</small>
                                        </div>
                                    </td>
                                    <td>
                                        <span class="orden-estado estado-{{ orden.estado|lower }}">
                                            {{ orden.get_estado_display }}
                                        </span>
                                    </td>
                                    <td>
                                        <div class="progress-container">
                                            <div class="progress-bar-custom">
                                                <div class="progress-fill" style="width: {{ orden.porcentaje_completado }}%"></div>
                                            </div>
                                            <div class="progress-text">{{ orden.porcentaje_completado }}%</div>
                                        </div>
                                    </td>
                                    <td>
                                        <small>{{ orden.fecha_creacion|date:"d/m/Y H:i" }}</small>
                                    </td>
                                    <td>
                                        <div class="btn-group">
                                            <a href="{% url 'pedidos_avanzados:detalle_orden' orden.id %}" 
                                               class="btn btn-sm btn-outline-primary">
                                                <i class="fas fa-eye"></i>
                                            </a>
                                            {% if orden.estado == 'ACTIVO' %}
                                            <button class="btn btn-sm btn-outline-success" 
                                                    onclick="actualizarEstadoOrden({{ orden.id }}, 'PENDIENTE')">
                                                <i class="fas fa-check"></i>
                                            </button>
                                            {% endif %}
                                        </div>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                {% else %}
                    <div class="text-center py-5">
                        <i class="fas fa-inbox fa-3x text-muted mb-3"></i>
                        <h5 class="text-muted">No hay órdenes recientes</h5>
                        <p class="text-muted">Las órdenes creadas aparecerán aquí</p>
                        <a href="{% url 'pedidos_avanzados:crear_orden' %}" class="btn btn-primary-custom">
                            <i class="fas fa-plus"></i> Crear Primera Orden
                        </a>
                    </div>
                {% endif %}
            </div>
        </div>
    </div>
    
    <!-- Panel Lateral - Alertas y Notificaciones -->
    <div class="col-lg-4">
        <!-- Notas de Crédito por Vencer -->
        <div class="main-card mb-3">
            <div class="card-header-custom">
                <h4 class="mb-0">
                    <i class="fas fa-exclamation-circle"></i>
                    Créditos por Vencer
                </h4>
            </div>
            
            <div class="card-body">
                {% if notas_por_vencer %}
                    {% for nota in notas_por_vencer %}
                    <div class="alert alert-warning d-flex align-items-center mb-2">
                        <i class="fas fa-clock me-2"></i>
                        <div>
                            <strong>{{ nota.cliente.nombre }}</strong><br>
                            <small>
                                ${{ nota.monto }} - Vence: {{ nota.fecha_vencimiento|date:"d/m/Y" }}
                            </small>
                        </div>
                    </div>
                    {% endfor %}
                    
                    <div class="text-center mt-3">
                        <a href="{% url 'pedidos_avanzados:reportes' %}" class="btn btn-outline-warning btn-sm">
                            Ver Todas las Notas
                        </a>
                    </div>
                {% else %}
                    <div class="text-center text-muted">
                        <i class="fas fa-check-circle fa-2x mb-2"></i>
                        <p class="mb-0">No hay créditos próximos a vencer</p>
                    </div>
                {% endif %}
            </div>
        </div>
        
        <!-- Acceso al Portal Cliente -->
        <div class="main-card">
            <div class="card-header-custom">
                <h4 class="mb-0">
                    <i class="fas fa-user-circle"></i>
                    Portal Cliente
                </h4>
            </div>
            
            <div class="card-body">
                <p class="text-muted mb-3">
                    Acceso rápido al portal del cliente para consultar órdenes y créditos.
                </p>
                
                <form method="get" action="{% url 'pedidos_avanzados:portal_cliente' %}">
                    <div class="input-group mb-3">
                        <select name="cliente_id" class="form-select" id="cliente-selector">
                            <option value="">Seleccionar cliente...</option>
                            {% for orden in ordenes_recientes %}
                                <option value="{{ orden.cliente.id }}">{{ orden.cliente.nombre }}</option>
                            {% endfor %}
                        </select>
                        <button class="btn btn-outline-primary" type="submit">
                            <i class="fas fa-arrow-right"></i>
                        </button>
                    </div>
                </form>
                
                <div class="d-grid">
                    <a href="{% url 'pedidos_avanzados:portal_cliente' %}" class="btn btn-outline-secondary btn-sm">
                        <i class="fas fa-list"></i> Ver Todos los Clientes
                    </a>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block pedidos_extra_js %}
<script>
$(document).ready(function() {
    // Auto-refresh cada 5 minutos
    setTimeout(function() {
        location.reload();
    }, 300000);
    
    // Tooltip para botones
    $('[data-bs-toggle="tooltip"]').tooltip();
    
    // Selector de cliente con search
    $('#cliente-selector').select2({
        placeholder: 'Buscar cliente...',
        allowClear: true,
        width: '100%'
    });
});
</script>
{% endblock %}
