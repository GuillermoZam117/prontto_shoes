{% extends "layouts/base.html" %}

{% block title %}Inicio | Panel de Control{% endblock %}

{% block page_title %}Panel de Control{% endblock %}

{% block breadcrumbs_content %}
    <li class="breadcrumb-item active">Dashboard</li>
{% endblock %}

{% block content %}
<div class="row">
    <!-- Resumen de ventas -->
    <div class="col-md-6 col-xl-3 mb-4">
        <div class="card border-left-primary h-100">
            <div class="card-body">
                <div class="row no-gutters align-items-center">
                    <div class="col mr-2">
                        <div class="text-xs font-weight-bold text-primary text-uppercase mb-1">
                            Ventas (Hoy)
                        </div>
                        <div class="h5 mb-0 font-weight-bold text-gray-800" id="ventas-hoy">
                            ${{ ventas_hoy|default:"0.00" }}
                        </div>
                    </div>
                    <div class="col-auto">
                        <i class="bi bi-cart-check-fill fa-2x text-gray-300"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Pedidos por Surtir -->
    <div class="col-md-6 col-xl-3 mb-4">
        <div class="card border-left-warning h-100">
            <div class="card-body">
                <div class="row no-gutters align-items-center">
                    <div class="col mr-2">
                        <div class="text-xs font-weight-bold text-warning text-uppercase mb-1">
                            Pedidos por Surtir
                        </div>
                        <div class="h5 mb-0 font-weight-bold text-gray-800" id="pedidos-pendientes">
                            {{ pedidos_pendientes|default:"0" }}
                        </div>
                    </div>
                    <div class="col-auto">
                        <i class="bi bi-clipboard-check fa-2x text-gray-300"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Productos con Stock Bajo -->
    <div class="col-md-6 col-xl-3 mb-4">
        <div class="card border-left-danger h-100">
            <div class="card-body">
                <div class="row no-gutters align-items-center">
                    <div class="col mr-2">
                        <div class="text-xs font-weight-bold text-danger text-uppercase mb-1">
                            Stock Bajo
                        </div>
                        <div class="h5 mb-0 font-weight-bold text-gray-800" id="stock-bajo">
                            {{ stock_bajo|default:"0" }}
                        </div>
                    </div>
                    <div class="col-auto">
                        <i class="bi bi-exclamation-triangle fa-2x text-gray-300"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Ventas del Mes -->
    <div class="col-md-6 col-xl-3 mb-4">
        <div class="card border-left-success h-100">
            <div class="card-body">
                <div class="row no-gutters align-items-center">
                    <div class="col mr-2">
                        <div class="text-xs font-weight-bold text-success text-uppercase mb-1">
                            Ventas (Mes)
                        </div>
                        <div class="h5 mb-0 font-weight-bold text-gray-800" id="ventas-mes">
                            ${{ ventas_mes|default:"0.00" }}
                        </div>
                    </div>
                    <div class="col-auto">
                        <i class="bi bi-graph-up fa-2x text-gray-300"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="row">
    <!-- Gráfico de Ventas -->
    <div class="col-xl-8 col-lg-7 mb-4">
        <div class="card shadow mb-4">
            <div class="card-header py-3 d-flex flex-row align-items-center justify-content-between">
                <h6 class="m-0 font-weight-bold text-primary">Ventas de los Últimos 7 Días</h6>
            </div>
            <div class="card-body">
                <div class="chart-area">
                    <canvas id="ventas-chart"></canvas>
                </div>
            </div>
        </div>
    </div>

    <!-- Últimas Actividades -->
    <div class="col-xl-4 col-lg-5 mb-4">
        <div class="card shadow mb-4">
            <div class="card-header py-3">
                <h6 class="m-0 font-weight-bold text-primary">Últimas Actividades</h6>
            </div>
            <div class="card-body">
                {% if actividades %}
                    <div class="list-group list-group-flush">
                        {% for actividad in actividades %}
                            <div class="list-group-item py-3 px-0 border-bottom">
                                <div class="d-flex w-100 justify-content-between">
                                    <h6 class="mb-1">{{ actividad.titulo }}</h6>
                                    <small>{{ actividad.fecha|date:"d/m/Y H:i" }}</small>
                                </div>
                                <p class="mb-1">{{ actividad.descripcion }}</p>
                                <small class="text-muted">{{ actividad.usuario }}</small>
                            </div>
                        {% endfor %}
                    </div>
                {% else %}
                    <p class="text-center text-muted my-3">No hay actividades recientes</p>
                {% endif %}

                <div class="text-center mt-3">
                    <a href="{% url 'administracion:logs' %}" class="btn btn-sm btn-outline-primary">Ver más actividades</a>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="row">
    <!-- Pedidos Recientes -->
    <div class="col-lg-6 mb-4">
        <div class="card shadow mb-4">
            <div class="card-header py-3">
                <h6 class="m-0 font-weight-bold text-primary">Pedidos Recientes</h6>
            </div>
            <div class="card-body">
                {% if pedidos %}
                    <div class="table-responsive">
                        <table class="table table-sm table-hover">
                            <thead>
                                <tr>
                                    <th>#</th>
                                    <th>Cliente</th>
                                    <th>Fecha</th>
                                    <th>Total</th>
                                    <th>Estado</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for pedido in pedidos %}
                                <tr>
                                    <td><a href="{% url 'ventas:detalle_pedido' pedido.id %}">{{ pedido.folio }}</a></td>
                                    <td>{{ pedido.cliente }}</td>
                                    <td>{{ pedido.fecha|date:"d/m/Y" }}</td>
                                    <td>${{ pedido.total }}</td>
                                    <td>
                                        {% if pedido.estado == 'pendiente' %}
                                            <span class="badge bg-warning text-dark">Pendiente</span>
                                        {% elif pedido.estado == 'completado' %}
                                            <span class="badge bg-success">Completado</span>
                                        {% elif pedido.estado == 'cancelado' %}
                                            <span class="badge bg-danger">Cancelado</span>
                                        {% else %}
                                            <span class="badge bg-secondary">{{ pedido.estado }}</span>
                                        {% endif %}
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                {% else %}
                    <p class="text-center text-muted my-3">No hay pedidos recientes</p>
                {% endif %}

                <div class="text-center mt-3">
                    <a href="{% url 'ventas:pedidos' %}" class="btn btn-sm btn-outline-primary">Ver todos los pedidos</a>
                </div>
            </div>
        </div>
    </div>

    <!-- Productos Populares -->
    <div class="col-lg-6 mb-4">
        <div class="card shadow mb-4">
            <div class="card-header py-3">
                <h6 class="m-0 font-weight-bold text-primary">Productos más Vendidos</h6>
            </div>
            <div class="card-body">
                {% if productos_populares %}
                    <div class="table-responsive">
                        <table class="table table-sm table-hover">
                            <thead>
                                <tr>
                                    <th>Producto</th>
                                    <th>Código</th>
                                    <th>Categoría</th>
                                    <th>Ventas</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for producto in productos_populares %}
                                <tr>
                                    <td><a href="{% url 'productos:detalle' producto.id %}">{{ producto.nombre }}</a></td>
                                    <td>{{ producto.codigo }}</td>
                                    <td>{{ producto.categoria }}</td>
                                    <td>{{ producto.ventas }}</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                {% else %}
                    <p class="text-center text-muted my-3">No hay datos de ventas disponibles</p>
                {% endif %}

                <div class="text-center mt-3">
                    <a href="{% url 'reportes:ventas_producto' %}" class="btn btn-sm btn-outline-primary">Ver reporte completo</a>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Gráfico de ventas
    const ctx = document.getElementById('ventas-chart');
    
    if (ctx) {
        new Chart(ctx, {
            type: 'line',
            data: {
                labels: {{ fechas|safe|default:"[]" }},
                datasets: [{
                    label: 'Ventas',
                    data: {{ ventas_diarias|safe|default:"[]" }},
                    backgroundColor: 'rgba(0, 51, 102, 0.1)',
                    borderColor: 'rgba(0, 51, 102, 0.8)',
                    borderWidth: 2,
                    pointBackgroundColor: 'rgba(0, 51, 102, 0.8)',
                    tension: 0.3
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: {
                            callback: function(value) {
                                return '$' + value.toLocaleString('es-MX');
                            }
                        }
                    }
                },
                plugins: {
                    legend: {
                        display: false
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                return 'Ventas: $' + context.raw.toLocaleString('es-MX');
                            }
                        }
                    }
                }
            }
        });
    }
    
    // Actualización en tiempo real
    const updateInterval = 5 * 60 * 1000; // 5 minutos
    
    const updateDashboard = function() {
        fetch('{% url "dashboard:data" %}')
            .then(response => response.json())
            .then(data => {
                // Actualizar contadores
                document.getElementById('ventas-hoy').textContent = '$' + data.ventas_hoy;
                document.getElementById('ventas-mes').textContent = '$' + data.ventas_mes;
                document.getElementById('pedidos-pendientes').textContent = data.pedidos_pendientes;
                document.getElementById('stock-bajo').textContent = data.stock_bajo;
                
                // Notificar si hay nuevos pedidos
                if (data.nuevos_pedidos > 0) {
                    ProntoApp.notify(
                        'Nuevos Pedidos',
                        `Se han recibido ${data.nuevos_pedidos} nuevos pedidos.`,
                        'info'
                    );
                }
            })
            .catch(error => console.error('Error al actualizar dashboard:', error));
    };
    
    // Actualizar cada 5 minutos
    setInterval(updateDashboard, updateInterval);
    
    // Escuchar eventos de sincronización
    document.addEventListener('sync:statusChanged', function(event) {
        if (event.detail.status === 'syncing') {
            console.log('Sincronizando datos...');
        } else if (event.detail.status === 'connected') {
            updateDashboard();
        }
    });
});
</script>
{% endblock %} 