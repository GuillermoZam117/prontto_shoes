{% extends "layouts/base.html" %}
{% load static %}

{% block title %}{% if producto %}Editar{% else %}Nuevo{% endif %} Producto{% endblock %}

{% block page_title %}{% if producto %}Editar{% else %}Nuevo{% endif %} Producto{% endblock %}

{% block breadcrumbs_content %}
    <li class="breadcrumb-item"><a href="{% url 'productos:lista' %}">Productos</a></li>
    <li class="breadcrumb-item active">{% if producto %}Editar {{ producto.codigo }}{% else %}Nuevo Producto{% endif %}</li>
{% endblock %}

{% block content %}
<div class="card shadow mb-4">
    <div class="card-header py-3">
        <h6 class="m-0 font-weight-bold text-primary">{% if producto %}Editar{% else %}Crear{% endif %} Producto</h6>
    </div>
    <div class="card-body">
        <form method="post" class="needs-validation" novalidate>
            {% csrf_token %}
            
            <div class="row mb-3">
                <div class="col-md-6">
                    <div class="mb-3">
                        <label for="codigo" class="form-label">Código *</label>
                        <input type="text" class="form-control" id="codigo" name="codigo" value="{{ producto.codigo|default:'' }}" required>
                        <div class="invalid-feedback">El código es obligatorio</div>
                    </div>
                </div>
                
                <div class="col-md-6">
                    <div class="mb-3">
                        <label for="nombre" class="form-label">Nombre *</label>
                        <input type="text" class="form-control" id="nombre" name="nombre" value="{{ producto.nombre|default:'' }}" required>
                        <div class="invalid-feedback">El nombre es obligatorio</div>
                    </div>
                </div>
            </div>
            
            <div class="row mb-3">
                <div class="col-md-4">
                    <div class="mb-3">
                        <label for="marca" class="form-label">Marca *</label>
                        <input type="text" class="form-control" id="marca" name="marca" value="{{ producto.marca|default:'' }}" required>
                        <div class="invalid-feedback">La marca es obligatoria</div>
                    </div>
                </div>
                
                <div class="col-md-4">
                    <div class="mb-3">
                        <label for="modelo" class="form-label">Modelo *</label>
                        <input type="text" class="form-control" id="modelo" name="modelo" value="{{ producto.modelo|default:'' }}" required>
                        <div class="invalid-feedback">El modelo es obligatorio</div>
                    </div>
                </div>
                
                <div class="col-md-4">
                    <div class="mb-3">
                        <label for="color" class="form-label">Color *</label>
                        <input type="text" class="form-control" id="color" name="color" value="{{ producto.color|default:'' }}" required>
                        <div class="invalid-feedback">El color es obligatorio</div>
                    </div>
                </div>
            </div>
            
            <div class="row mb-3">
                <div class="col-md-4">
                    <div class="mb-3">
                        <label for="propiedad" class="form-label">Propiedad</label>
                        <input type="text" class="form-control" id="propiedad" name="propiedad" value="{{ producto.propiedad|default:'' }}">
                    </div>
                </div>
                
                <div class="col-md-4">
                    <div class="mb-3">
                        <label for="costo" class="form-label">Costo *</label>
                        <div class="input-group">
                            <span class="input-group-text">$</span>
                            <input type="number" step="0.01" min="0" class="form-control" id="costo" name="costo" value="{{ producto.costo|default:'' }}" required>
                            <div class="invalid-feedback">El costo es obligatorio y debe ser mayor que cero</div>
                        </div>
                    </div>
                </div>
                
                <div class="col-md-4">
                    <div class="mb-3">
                        <label for="precio" class="form-label">Precio de Venta *</label>
                        <div class="input-group">
                            <span class="input-group-text">$</span>
                            <input type="number" step="0.01" min="0" class="form-control" id="precio" name="precio" value="{{ producto.precio|default:'' }}" required>
                            <div class="invalid-feedback">El precio es obligatorio y debe ser mayor que cero</div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="row mb-3">
                <div class="col-md-4">
                    <div class="mb-3">
                        <label for="catalogo" class="form-label">Catálogo *</label>
                        <select class="form-select select2" id="catalogo" name="catalogo" required>
                            <option value="">Seleccionar...</option>
                            <!-- Options will be populated dynamically -->
                        </select>
                        <div class="invalid-feedback">Seleccione un catálogo</div>
                    </div>
                </div>
                
                <div class="col-md-4">
                    <div class="mb-3">
                        <label for="numero_pagina" class="form-label">Número de Página</label>
                        <input type="number" min="1" class="form-control" id="numero_pagina" name="numero_pagina" value="{{ producto.numero_pagina|default:'' }}">
                    </div>
                </div>
                
                <div class="col-md-4">
                    <div class="mb-3">
                        <label for="proveedor" class="form-label">Proveedor *</label>
                        <select class="form-select select2" id="proveedor" name="proveedor" required>
                            <option value="">Seleccionar...</option>
                            <!-- Options will be populated dynamically -->
                        </select>
                        <div class="invalid-feedback">Seleccione un proveedor</div>
                    </div>
                </div>
            </div>
            
            <div class="row mb-4">
                <div class="col-md-4">
                    <div class="mb-3">
                        <label for="temporada" class="form-label">Temporada</label>
                        <select class="form-select" id="temporada" name="temporada">
                            <option value="">Sin temporada</option>
                            <option value="Verano" {% if producto.temporada == 'Verano' %}selected{% endif %}>Verano</option>
                            <option value="Invierno" {% if producto.temporada == 'Invierno' %}selected{% endif %}>Invierno</option>
                            <option value="Primavera" {% if producto.temporada == 'Primavera' %}selected{% endif %}>Primavera</option>
                            <option value="Otoño" {% if producto.temporada == 'Otoño' %}selected{% endif %}>Otoño</option>
                        </select>
                    </div>
                </div>
                
                <div class="col-md-4">
                    <div class="mb-3">
                        <label for="tienda" class="form-label">Tienda Principal *</label>
                        <select class="form-select select2" id="tienda" name="tienda" required>
                            <option value="">Seleccionar...</option>
                            <!-- Options will be populated dynamically -->
                        </select>
                        <div class="invalid-feedback">Seleccione una tienda</div>
                    </div>
                </div>
                
                <div class="col-md-4">
                    <div class="mb-3">
                        <label for="stock_minimo" class="form-label">Stock Mínimo</label>
                        <input type="number" min="0" class="form-control" id="stock_minimo" name="stock_minimo" value="{{ producto.stock_minimo|default:'5' }}">
                    </div>
                </div>
            </div>
            
            <div class="row mb-4">
                <div class="col-md-6">
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" value="1" id="oferta" name="oferta" {% if producto.oferta %}checked{% endif %}>
                        <label class="form-check-label" for="oferta">
                            Producto en Oferta
                        </label>
                    </div>
                </div>
                
                <div class="col-md-6">
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" value="1" id="admite_devolucion" name="admite_devolucion" {% if producto.admite_devolucion %}checked{% endif %}>
                        <label class="form-check-label" for="admite_devolucion">
                            Admite Devolución
                        </label>
                    </div>
                </div>
            </div>
            
            <div class="d-flex justify-content-end">
                <a href="{% url 'productos:lista' %}" class="btn btn-secondary me-2">Cancelar</a>
                <button type="submit" class="btn btn-primary">Guardar</button>
            </div>
        </form>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    $(document).ready(function() {
        // Initialize Select2
        $('.select2').select2({
            theme: 'bootstrap-5'
        });
        
        // Form validation
        (function () {
            'use strict'
            
            // Fetch all forms we want to apply custom validation to
            var forms = document.querySelectorAll('.needs-validation')
            
            // Loop over them and prevent submission
            Array.prototype.slice.call(forms).forEach(function (form) {
                form.addEventListener('submit', function (event) {
                    if (!form.checkValidity()) {
                        event.preventDefault()
                        event.stopPropagation()
                    }
                    
                    form.classList.add('was-validated')
                }, false)
            })
        })()
        
        // Fetch and populate select options dynamically
        $.ajax({
            url: '/api/catalogos/',
            method: 'GET',
            success: function(data) {
                var select = $('#catalogo');
                $.each(data, function(i, item) {
                    var selected = {{ producto.catalogo.id|default:0 }} == item.id;
                    select.append($('<option>', { 
                        value: item.id,
                        text: item.nombre,
                        selected: selected
                    }));
                });
            }
        });
        
        $.ajax({
            url: '/api/proveedores/',
            method: 'GET',
            success: function(data) {
                var select = $('#proveedor');
                $.each(data, function(i, item) {
                    var selected = {{ producto.proveedor.id|default:0 }} == item.id;
                    select.append($('<option>', { 
                        value: item.id,
                        text: item.nombre,
                        selected: selected
                    }));
                });
            }
        });
        
        $.ajax({
            url: '/api/tiendas/',
            method: 'GET',
            success: function(data) {
                var select = $('#tienda');
                $.each(data, function(i, item) {
                    var selected = {{ producto.tienda.id|default:0 }} == item.id;
                    select.append($('<option>', { 
                        value: item.id,
                        text: item.nombre,
                        selected: selected
                    }));
                });
            }
        });
    });
</script>
{% endblock %} 