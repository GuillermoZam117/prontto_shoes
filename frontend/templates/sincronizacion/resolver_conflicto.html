{% extends "base.html" %}
{% load static %}

{% block title %}Resolver Conflicto{% endblock %}

{% block content %}
<div class="container-fluid px-4">
    <h1 class="mt-4">Resolver Conflicto de Sincronización</h1>
    <ol class="breadcrumb mb-4">
        <li class="breadcrumb-item"><a href="{% url 'dashboard' %}">Dashboard</a></li>
        <li class="breadcrumb-item"><a href="{% url 'sincronizacion_dashboard' %}">Sincronización</a></li>
        <li class="breadcrumb-item active">Resolver Conflicto</li>
    </ol>
    
    <div class="row">
        <div class="col-md-12">
            <div class="card mb-4">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <div>
                        <i class="fas fa-exclamation-triangle me-1 text-warning"></i>
                        Conflicto ID: {{ operacion.id }}
                    </div>
                    <div class="badge bg-warning text-dark">
                        {{ operacion.content_type.app_label }}.{{ operacion.content_type.model }} - {{ operacion.get_tipo_operacion_display }}
                    </div>
                </div>
                <div class="card-body">
                    <div class="row mb-4">
                        <div class="col-md-4">
                            <strong>Tienda Origen:</strong> {{ operacion.tienda_origen.nombre }}
                        </div>
                        <div class="col-md-4">
                            <strong>Tienda Destino:</strong> 
                            {% if operacion.tienda_destino %}
                                {{ operacion.tienda_destino.nombre }}
                            {% else %}
                                Servidor Central
                            {% endif %}
                        </div>
                        <div class="col-md-4">
                            <strong>Fecha de Creación:</strong> {{ operacion.fecha_creacion|date:"d/m/Y H:i" }}
                        </div>
                    </div>
                    
                    <h5 class="border-bottom pb-2">Detalles del Conflicto</h5>
                    
                    <div class="row mt-4">
                        <div class="col-md-6">
                            <div class="card mb-4">
                                <div class="card-header bg-light">
                                    <i class="fas fa-laptop me-1"></i>
                                    Datos Locales
                                </div>
                                <div class="card-body">
                                    <pre class="bg-light p-3 rounded" id="datos-locales">{{ operacion.datos|pprint }}</pre>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="card mb-4">
                                <div class="card-header bg-light">
                                    <i class="fas fa-server me-1"></i>
                                    Datos del Servidor
                                </div>
                                <div class="card-body">
                                    <div class="alert alert-info">
                                        <i class="fas fa-info-circle me-1"></i>
                                        Los datos del servidor se cargarán automáticamente al seleccionar la opción de resolución.
                                    </div>
                                    <pre class="bg-light p-3 rounded" id="datos-servidor"></pre>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <h5 class="border-bottom pb-2">Opciones de Resolución</h5>
                    
                    <form id="conflict-resolution-form" method="post" action="{% url 'resolver_conflicto' operacion.id %}">
                        {% csrf_token %}
                        
                        <div class="form-check mt-3">
                            <input class="form-check-input" type="radio" name="resolucion" id="usar-servidor" value="servidor" checked>
                            <label class="form-check-label" for="usar-servidor">
                                <strong>Usar datos del servidor</strong> - Se descartarán los cambios locales
                            </label>
                        </div>
                        
                        <div class="form-check mt-2">
                            <input class="form-check-input" type="radio" name="resolucion" id="usar-local" value="local">
                            <label class="form-check-label" for="usar-local">
                                <strong>Usar datos locales</strong> - Se sobrescribirán los datos del servidor
                            </label>
                        </div>
                        
                        <div class="form-check mt-2">
                            <input class="form-check-input" type="radio" name="resolucion" id="personalizado" value="personalizado">
                            <label class="form-check-label" for="personalizado">
                                <strong>Personalizar resolución</strong> - Editar manualmente los datos
                            </label>
                        </div>
                        
                        <div id="personalizado-container" class="mt-3 d-none">
                            <textarea id="datos-personalizados" name="datos_personalizados" class="form-control" rows="10"></textarea>
                            <div class="form-text">
                                Edite los datos en formato JSON respetando la estructura original
                            </div>
                        </div>
                        
                        <div class="mt-4 d-flex justify-content-end">
                            <a href="{% url 'sincronizacion_dashboard' %}" class="btn btn-secondary me-2">Cancelar</a>
                            <button type="submit" class="btn btn-primary">Resolver Conflicto</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Mostrar/ocultar editor personalizado
        const radios = document.querySelectorAll('input[name="resolucion"]');
        const personalizadoContainer = document.getElementById('personalizado-container');
        const datosPersonalizados = document.getElementById('datos-personalizados');
        const datosLocales = document.getElementById('datos-locales');
        
        // Convertir datos locales a formato JSON para edición
        try {
            let datosLocalesObj = JSON.parse(datosLocales.textContent);
            datosPersonalizados.value = JSON.stringify(datosLocalesObj, null, 2);
        } catch (e) {
            console.error('Error al parsear datos locales:', e);
            datosPersonalizados.value = datosLocales.textContent;
        }
        
        // Mostrar/ocultar según selección
        radios.forEach(function(radio) {
            radio.addEventListener('change', function() {
                if (this.value === 'personalizado') {
                    personalizadoContainer.classList.remove('d-none');
                } else {
                    personalizadoContainer.classList.add('d-none');
                }
            });
        });
        
        // Validar JSON antes de enviar
        document.getElementById('conflict-resolution-form').addEventListener('submit', function(e) {
            if (document.getElementById('personalizado').checked) {
                try {
                    JSON.parse(datosPersonalizados.value);
                } catch (error) {
                    e.preventDefault();
                    alert('Por favor, ingrese un JSON válido para la resolución personalizada.');
                }
            }
        });
    });
</script>
{% endblock %}
